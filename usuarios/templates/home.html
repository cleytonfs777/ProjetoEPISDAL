{% extends 'base.html' %}
{% load static %}
{% load filters %}

{% block title %}Home{% endblock %}

{% block style %}
    .button-main {
        color: orange;
        font-weight: bold;
        font-size: 1.2rem;
    }
    .tags-input {
        display: flex;
        flex-wrap: wrap;
        border: 1px solid #ccc;
        padding: 5px;
        border-radius: 5px;
        margin-top: 10px;
    }
    .tags-input .tag {
        background-color: #add8e6;
        color: #000000;
        border-radius: 3px;
        padding: 5px;
        margin: 2px;
        display: flex;
        align-items: center;
    }
    .tags-input .tag .remove-tag {
        margin-left: 5px;
        cursor: pointer;
    }
    .tags-input input {
        border: none;
        outline: none;
        flex: 1;
    }
{% endblock %}
{% block max-title %}MEUS DADOS{% endblock%}
{% block content %}
<hr style="height: 3px;margin: 1.5rem;" class="bg-success">
<div class="container bg-light rounded">
    <div class="row py-4">
        <h2 style="color:#000000">Dados do Militar</h2>
    <div class="row py-2">
        <div class="col-md-4">
            <label for="numbm" class="form-label text-success">Nº</label>
            <input
                type="text"
                class="form-control"
                id="numbm"
                name="numbm"
                maxlength="9"
                value="{{ user.numbm }}"
                placeholder="Digite apenas os números"
                            style="font-size: 0.8em;"
                required
            />
        </div>
        <div class="col-md-4">
            <label for="namebm" class="form-label text-success">Nome</label>
            <input
                type="text"
                class="form-control"
                id="namebm"
                name="namebm"
                value="{{ user.get_full_name }}"
                            style="font-size: 0.8em;"
                required
            />
        </div>
        <div class="col-md-4">
            <label for="postgradbm" class="form-label text-success">Posto/Grad</label>
            <select
                class="form-select"
                aria-label="Default"
                id="postgradbm"
                name="postgradbm"
                            style="font-size: 0.8em;"
                required
            >
                <option selected disabled>Escolha o Posto/Grad</option>
                {% for key, value in user.postgrad_choices %}
                <option value="{{ key }}" {% if user.postgrad == key %}selected{% endif %}>{{ value }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="row pt-4">
        <div class="col-md-3">
            <label for="firstinc" class="form-label text-success">Data 1ª Inclusão</label>
            <input
                type="text"
                class="form-control"
                id="firstinc"
                name="firstinc"
                            style="font-size: 0.8em;"
                value="{{ user.date_include }}"
                required
                readonly
            />
        </div>
        <div class="col-md-3">
            <label for="tempserv" class="form-label text-success">Tempo de Serviço</label>
            <input
                type="text"
                class="form-control"
                id="tempserv"
                name="tempserv"
                            style="font-size: 0.8em;"
                value="{{ user.time_service_days|dias_para_anos}}"
                required
                readonly
            />
        </div>
        <div class="col-md-3">
            <label for="statusativ" class="form-label text-success">Status</label>
            <select
                class="form-select"
                aria-label="Default"
                id="statusativ"
                name="statusativ"
                            style="font-size: 0.8em;"
            >
                <option selected disabled>Escolha o Status</option>
                <option value="A" {% if user.status == 'A' %}selected{% endif %}>Ativo</option>
                <option value="I" {% if user.status == 'I' %}selected{% endif %}>Inativo</option>
            </select>
        </div>
        <div class="col-md-3">
            <label for="sitfunc" class="form-label text-success">Sit. Func</label>
            <select
            class="form-select"
            aria-label="Default"
            id="sitfunc"
            name="sitfunc"
            style="font-size: 0.8em;"
        >
            <option>Escolha a Sit. Func.</option>
            {% for key, value in choices_sitfunc %}
            <option value="{{ key }}" {% if user.sitfunc == key %}selected{% endif %}>{{ value }}</option>
            {% endfor %}
        </select>
        
        </div>
    </div>
    <div class="row pt-4">
        <div class="col-md-6">
            <!-- Input que receberá os GTOS -->
            <input type="hidden" id="gtos_own" name="gtos_own" value="{{ user.gto }}" style="font-size: 0.8em;">
            <label for="compgto" class="form-label text-success">GTO</label>
            <select class="form-select" aria-label="Default" id="compgto" name="compgto" style="font-size: 0.8em;">
                <option value="">Selecione um GTO</option>
                {% for gto in gtos %}
                <option value="{{ gto }}">{{ gto }}</option>
                {% endfor %}
            </select>
            <div class="tags-input" id="tags-input-gto"></div>
        </div>
        
        <div class="col-md-6">
            <!-- Checkbox para indicar se exerce atividade especializada -->
            <div class="form-check mb-2">
                {% if user.ativ_esp == 'S' %}
                <input class="form-check-input" type="checkbox" id="atividadeEspecializadaCheckbox" checked>
                {% else %}
                <input class="form-check-input" type="checkbox" id="atividadeEspecializadaCheckbox">
                {% endif %}
                <label class="form-check-label" for="atividadeEspecializadaCheckbox">
                    Exerce atividade especializada?
                </label>
            </div>
        
            <!-- Inputs e botão para adicionar atividade especializada -->
            <div class="input-group mb-3">
                <select class="form-select" id="atividadeSelect" disabled>
                    <option value="">Selecione uma Atividade</option>
                    <option value="Núcleo de Atenção e Resposta às Chuvas">Núcleo de Atenção e Resposta às Chuvas</option>
                    <option value="Núcleo de Incêndio Florestal">Núcleo de Incêndio Florestal</option>
                    <option value="Busca e Salvamento com Cães">Busca e Salvamento com Cães</option>
                    <option value="Perito de Incêndio e Explosão">Perito de Incêndio e Explosão</option>
                    <option value="Inspetor de Incêndio">Inspetor de Incêndio</option>
                    <option value="Motorresgate">Motorresgate</option>
                </select>
                <input type="text" class="form-control" id="docDesignInput" placeholder="Doc de Design" disabled>
                <button class="btn btn-success" type="button" id="addAtividadeBtn" disabled>+</button>
            </div>
        
            <!-- Div para exibir as atividades especializadas adicionadas -->
            <div class="tags-input" id="tags-atividade"></div>
         <!-- Input escondido para armazenar os valores concatenados -->
        <input type="hidden" id="exp_own" name="exp_own" value="" style="font-size: 0.8em;">
    </div>

    </div>
    <div class="row py-4">
        <div class="col-md-6">
            <label for="sexo" class="form-label text-success">Sexo</label>
            <select
                class="form-select"
                aria-label="Default"
                id="sexo"
                name="sexo"
                            style="font-size: 0.8em;"
            >
                <option value="M" {% if user.sexo == 'M' %}selected{% endif %}>Masculino</option>
                <option value="F" {% if user.sexo == 'F' %}selected{% endif %}>Feminino</option>
            </select>
        </div>
        <div class="col-md-6">
            <label for="emailfunc" class="form-label text-success">Email Funcional</label>
            <input
                type="email"
                class="form-control"
                id="emailfunc"
                name="emailfunc"
                value="{{ user.emailfunc }}"
                            style="font-size: 0.8em;"
                required
            />
        </div>
    </div>
    <div class="row py-4">
        <h2 style="color:#000000">Unidade de Lotação</h2>
    </div>
    <div class="row pt-4">
        <div class="col-md-3">
            <label for="cob" class="form-label text-success">COB</label>
            <input
                type="text"
                class="form-control"
                id="cob"
                name="cob"
                            style="font-size: 0.8em;"
                value="{{ user.cob }}"
                required
                readonly
            />
        </div>
        <div class="col-md-3">
            <label for="uniprinc" class="form-label text-success">Unidade Principal</label>
            <input
                type="text"
                class="form-control"
                id="uniprinc"
                name="uniprinc"
                            style="font-size: 0.8em;"
                value="{{ user.unid_princ }}"
                required
                readonly
            />
        </div>
        <div class="col-md-3">
            <label for="uniloc" class="form-label text-success">Unidade de Lotação</label>
            <input
                type="text"
                class="form-control"
                id="uniloc"
                name="uniloc"
                            style="font-size: 0.8em;"
                value="{{ user.unid_lot }}"
                required
                readonly
            />
        </div>
        <div class="col-md-3">
            <label for="priclassif" class="form-label text-success">Classificação(Prioridade pela ITLF)</label>
            <select
                class="form-select"
                aria-label="Default"
                id="priclassif"
                name="priclassif"
                            style="font-size: 0.8em;"
            >
                <option value="A" {% if user.priorit == 'A' %}selected{% endif %}>Alta</option>
                <option value="M" {% if user.priorit == 'M' %}selected{% endif %}>Média</option>
                <option value="B" {% if user.priorit == 'B' %}selected{% endif %}>Baixa</option>
            </select>
        </div>
    </div>
    <div class="row py-4 d-flex justify-content-end">
        <button type="button" class="btn btn-secondary w-25 m-4 button-main">Editar</button>
        <button type="button" id="validateButton" class="btn btn-secondary w-25 m-4 button-main">Salvar</button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Funções para o campo de GTO
        const tagsInputGTO = document.getElementById('tags-input-gto');
        const tagsSelectGTO = document.getElementById('compgto');
        const gtosOwnInput = document.getElementById('gtos_own');
    
        let gtoList = [];
    
        // Função para carregar os GTOS iniciais
        function loadInitialGtoTags(gtos_user) {
            if (gtos_user) {
                const gtos = gtos_user.split(';'); // Separar pelos ';'
                gtos.forEach(function (gto) {
                    gto = gto.trim();
                    if (gto && !gtoTagExists(gto)) {
                        gtoList.push(gto);
                        renderGtoTag(gto);
                    }
                });
                updateGtoOwnInput();
            }
        }
    
        // Adicionar a tag ao selecionar no select
        tagsSelectGTO.addEventListener('change', function () {
            const selectedGto = tagsSelectGTO.value.trim();
            if (selectedGto && !gtoTagExists(selectedGto)) {
                addGtoTag(selectedGto);
                tagsSelectGTO.value = ''; // Resetar o select após a seleção
            }
        });
    
        function addGtoTag(text) {
            gtoList.push(text);
            renderGtoTag(text);
            updateGtoOwnInput();
        }
    
        function renderGtoTag(text) {
            const tagElement = document.createElement('span');
            tagElement.classList.add('tag');
            tagElement.textContent = text;
    
            tagElement.style.fontSize = '0.8em';
    
            const removeTagElement = document.createElement('span');
            removeTagElement.classList.add('remove-tag');
            removeTagElement.textContent = 'x';
            removeTagElement.addEventListener('click', function () {
                removeGtoTag(text);
                tagsInputGTO.removeChild(tagElement);
            });
    
            tagElement.appendChild(removeTagElement);
            tagsInputGTO.appendChild(tagElement);
        }
    
        function removeGtoTag(text) {
            const index = gtoList.indexOf(text);
            if (index > -1) {
                gtoList.splice(index, 1);
                updateGtoOwnInput();
            }
        }
    
        function updateGtoOwnInput() {
            gtosOwnInput.value = gtoList.join(';');
        }
    
        function gtoTagExists(text) {
            return gtoList.includes(text);
        }
    
        // Carregar os GTOS iniciais do input oculto
        const gtos_user = gtosOwnInput.value;
        if (gtos_user) {
            loadInitialGtoTags(gtos_user);
        }
    
        // Funções para o campo de Atividades Especializadas
        const checkbox = document.getElementById('atividadeEspecializadaCheckbox');
        const atividadeSelect = document.getElementById('atividadeSelect');
        const docDesignInput = document.getElementById('docDesignInput');
        const addAtividadeBtn = document.getElementById('addAtividadeBtn');
        const tagsAtividadeInput = document.getElementById('tags-atividade');
        const expOwnInput = document.getElementById('exp_own');
    
        let atividadeList = [];
    
        // Função para carregar as atividades iniciais
        function loadInitialTags(ativ_esps) {
            const atividades = ativ_esps.split(';');
            atividades.forEach(function (atividade) {
                if (atividade.trim() && !atividadeTagExists(atividade)) {
                    atividadeList.push(atividade); // Adiciona à lista
                    renderAtividadeTag(atividade);
                }
            });
            updateExpOwnInput(); // Atualiza o input após carregar as tags
        }
    
        // Ativar/desativar select, input e botão baseado no checkbox
        checkbox.addEventListener('change', function () {
            const isChecked = !checkbox.checked;
            atividadeSelect.disabled = isChecked;
            docDesignInput.disabled = isChecked;
            addAtividadeBtn.disabled = isChecked;
        });
    
        // Adicionar a atividade especializada ao clicar no botão "+"
        addAtividadeBtn.addEventListener('click', function () {
            const atividade = atividadeSelect.value.trim();
            const docDesign = docDesignInput.value.trim();
    
            if (!atividade || !docDesign) {
                alert('Por favor, preencha ambos os campos.');
                return;
            }
    
            const tagText = `${atividade} - ${docDesign}`;
            addAtividadeTag(tagText);
    
            // Limpar os inputs
            atividadeSelect.value = '';
            docDesignInput.value = '';
        });
    
        function addAtividadeTag(text) {
            if (atividadeTagExists(text)) return;
    
            atividadeList.push(text);
            renderAtividadeTag(text);
            updateExpOwnInput();
        }
    
        function renderAtividadeTag(text) {
            const tagElement = document.createElement('span');
            tagElement.classList.add('tag');
            tagElement.textContent = text;
    
            tagElement.style.fontSize = '0.8em';
    
            const removeTagElement = document.createElement('span');
            removeTagElement.classList.add('remove-tag');
            removeTagElement.textContent = 'x';
            removeTagElement.addEventListener('click', function () {
                removeAtividadeTag(text);
                tagsAtividadeInput.removeChild(tagElement);
            });
    
            tagElement.appendChild(removeTagElement);
            tagsAtividadeInput.appendChild(tagElement);
        }
    
        function removeAtividadeTag(text) {
            const index = atividadeList.indexOf(text);
            if (index > -1) {
                atividadeList.splice(index, 1);
            }
            updateExpOwnInput();
        }
    
        function updateExpOwnInput() {
            expOwnInput.value = atividadeList.join(';');
        }
    
        function atividadeTagExists(text) {
            return atividadeList.includes(text);
        }
    
        // Variável inicial de atividades especializadas (simulação)
        const ativ_esps = "{{ user.list_ativ_esp|escapejs }}";  // Receba essa variável do backend Django
    
        if (ativ_esps && ativ_esps !== "None") {
            loadInitialTags(ativ_esps);
        }
    });
    
</script>
{% endblock %}
